{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "DC/OS Cluster",
  "Mappings": {
    "CENTOS7AMI": {
      "ap-south-1": {
        "AMI": "ami-95cda6fa"
      },
      "ap-northeast-2": {
        "AMI": "ami-c74789a9"
      },
      "ap-southeast-1": {
        "AMI": "ami-f068a193"
      },
      "ap-southeast-2": {
        "AMI": "ami-fedafc9d"
      },
      "ap-northeast-1": {
        "AMI": "ami-eec1c380"
      },
      "ca-central-1": {
        "AMI": "ami-af62d0cb"
      },
      "eu-central-1": {
        "AMI": "ami-9bf712f4"
      },
      "eu-west-1": {
        "AMI": "ami-7abd0209"
      },
      "eu-west-2": {
        "AMI": "ami-bb373ddf"
      },
      "sa-east-1": {
        "AMI": "ami-26b93b4a"
      },
      "us-east-1": {
        "AMI": "ami-6d1c2007"
      },
      "us-east-2": {
        "AMI": "ami-6a2d760f"
      },
      "us-west-1": {
        "AMI": "ami-af4333cf"
      },
      "us-west-2": {
        "AMI": "ami-d2c924b2"
      }
    },
    "DNSMAPPING": {
      "ap-south-1": {
        "NAME": "ap-south-1.compute.internal"
      },
      "ap-northeast-2": {
        "NAME": "ap-northeast-2.compute.internal"
      },
      "ap-southeast-1": {
        "NAME": "ap-southeast-1.compute.internal"
      },
      "ap-southeast-2": {
        "NAME": "ap-southeast-2.compute.internal"
      },
      "ap-northeast-1": {
        "NAME": "ap-northeast-1.compute.internal"
      },
      "ca-central-1": {
        "NAME": "ca-central-1.compute.internal"
      },
      "eu-central-1": {
        "NAME": "eu-central-1.compute.internal"
      },
      "eu-west-1": {
        "NAME": "eu-west-1.compute.internal"
      },
      "eu-west-2": {
        "NAME": "eu-west-2.compute.internal"
      },
      "sa-east-1": {
        "NAME": "sa-east-1.compute.internal"
      },
      "us-east-1": {
        "NAME": "ec2.internal"
      },
      "us-east-2": {
        "NAME": "us-east-2.compute.internal"
      },
      "us-west-1": {
        "NAME": "us-west-1.compute.internal"
      },
      "us-west-2": {
        "NAME": "us-west-2.compute.internal"
      }
    },
    "VARIABLES": {
      "MASTER": {
        "TYPE": "t2.micro",
        "SPOTPRICE": "0.012",
        "ROOTDISK": "10",
        "COUNT": "3"
      },
      "PRIVATEAGENT": {
        "TYPE": "t2.micro",
        "SPOTPRICE": "0.012",
        "ROOTDISK": "10",
        "COUNT": "3"
      },
      "PUBLICAGENT": {
        "TYPE": "t2.micro",
        "SPOTPRICE": "0.012",
        "ROOTDISK": "10",
        "COUNT": "3"
      },
      "NETWORK": {
        "VPC": "10.100.0.0/16",
        "USEAST1VPC": "10.200.0.0/16",
        "USEAST1VPCPCID": "pcx-00000000",
        "PRIVATESUBNETa": "10.100.32.0/20",
        "PRIVATESUBNETb": "10.100.64.0/20",
        "PRIVATESUBNETc": "10.100.96.0/20",
        "PUBLICSUBNETa": "10.100.48.0/20",
        "PUBLICSUBNETb": "10.100.80.0/20",
        "PUBLICSUBNETc": "10.100.112.0/20",
        "AZa": "us-east-1a",
        "AZb": "us-east-1b",
        "AZc": "us-east-1c"
      },
      "RDS": {
        "DBNAME": "database01",
        "USER": "db01admin",
        "PASSWORD": "H4ugyFX2oL9%BYEmx8;Z",
        "TYPE": "db.t2.medium",
        "STORAGE": 20
      },
      "TIMEOUT": {
        "INSTANCE": "PT90M",
        "STACK": "PT90M"
      },
      "STACK": {
        "ADMINLOCATION": "100.101.102.103/32",
        "KEYNAME": "ssh-key",
        "OAUTHENABLED": "false"
      }
    }
  },
  "Outputs": {
    "PublicSlaveDnsAddress": {
      "Description": "Public slaves",
      "Value": {
        "Fn::GetAtt": [
          "elbagentpublicexternal",
          "DNSName"
        ]
      }
    },
    "bucket00ex": {
      "Description": "Exhibitor S3 bucket name",
      "Value": {
        "Ref": "bucket00ex"
      }
    },
    "DnsAddress": {
      "Description": "Mesos Master",
      "Value": {
        "Fn::GetAtt": [
          "elbmasterexternal",
          "DNSName"
        ]
      }
    }
  },
  "Resources": {
    "bucket00ex": {
      "Type": "AWS::S3::Bucket",
      "DeletionPolicy": "Retain"
    },

    "eipa": {
      "Type": "AWS::EC2::EIP",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "eipb": {
      "Type": "AWS::EC2::EIP",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "Domain": "vpc"
      }
    },
    "eipc": {
      "Type": "AWS::EC2::EIP",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "Domain": "vpc"
      }
    },

    "vpc": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ],
        "EnableDnsHostnames": "true",
        "EnableDnsSupport": "true",
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "VPC"
          ]
        }
      }
    },

    "subnetprivatea": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Private",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZa"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PRIVATESUBNETa"
          ]
        }
      }
    },
    "subnetprivateb": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Private",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZb"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PRIVATESUBNETb"
          ]
        }
      }
    },
    "subnetprivatec": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Private",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZc"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PRIVATESUBNETc"
          ]
        }
      }
    },

    "subnetpublica": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZa"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PUBLICSUBNETa"
          ]
        }
      }
    },
    "subnetpublicb": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZb"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PUBLICSUBNETb"
          ]
        }
      }
    },
    "subnetpublicc": {
      "Type": "AWS::EC2::Subnet",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ],
        "AvailabilityZone": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "AZc"
          ]
        },
        "CidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "PUBLICSUBNETc"
          ]
        }
      }
    },

    "natgatewaya": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "eipa",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "subnetpublica"
        }
      }
    },
    "natgatewayb": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "eipb",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "subnetpublicb"
        }
      }
    },
    "natgatewayc": {
      "Type": "AWS::EC2::NatGateway",
      "Properties": {
        "AllocationId": {
          "Fn::GetAtt": [
            "eipc",
            "AllocationId"
          ]
        },
        "SubnetId": {
          "Ref": "subnetpublicc"
        }
      }
    },

    "efsfs": {
      "Type": "AWS::EFS::FileSystem",
      "Properties": {
        "FileSystemTags": [
          {
            "Key": "Name",
            "Value": "dcos-admin filesystem"
          }
        ],
        "PerformanceMode": "generalPurpose"
      }
    },
    "efsmounttargeta": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "efsfs"
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentprivate"
          }
        ],
        "SubnetId": {
          "Ref": "subnetprivatea"
        }
      }
    },
    "efsmounttargetb": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "efsfs"
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentprivate"
          }
        ],
        "SubnetId": {
          "Ref": "subnetprivateb"
        }
      }
    },
    "efsmounttargetc": {
      "Type": "AWS::EFS::MountTarget",
      "Properties": {
        "FileSystemId": {
          "Ref": "efsfs"
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentprivate"
          }
        ],
        "SubnetId": {
          "Ref": "subnetprivatec"
        }
      }
    },

    "iamrolemaster": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Path": "/",
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Action": [
                    "s3:AbortMultipartUpload",
                    "s3:DeleteObject",
                    "s3:GetBucketAcl",
                    "s3:GetBucketPolicy",
                    "s3:GetObject",
                    "s3:GetObjectAcl",
                    "s3:ListBucket",
                    "s3:ListBucketMultipartUploads",
                    "s3:ListMultipartUploadParts",
                    "s3:PutObject",
                    "s3:PutObjectAcl"
                  ],
                  "Effect": "Allow",
                  "Resource": [
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "bucket00ex"
                          },
                          "/*"
                        ]
                      ]
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          "arn:aws:s3:::",
                          {
                            "Ref": "bucket00ex"
                          }
                        ]
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:*"
                  ],
                  "Resource": [
                    {
                      "Ref": "AWS::StackId"
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "AWS::StackId"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:DescribeKeyPairs",
                    "ec2:DescribeSubnets",
                    "ec2:DescribeInstances",
                    "autoscaling:DescribeLaunchConfigurations",
                    "autoscaling:UpdateAutoScalingGroup",
                    "autoscaling:DescribeAutoScalingGroups",
                    "autoscaling:DescribeScalingActivities",
                    "elasticloadbalancing:DescribeLoadBalancers"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": "root"
          }
        ],
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              },
              "Effect": "Allow"
            }
          ]
        }
      }
    },
    "iamroleagent": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Policies": [
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:*"
                  ],
                  "Resource": [
                    {
                      "Ref": "AWS::StackId"
                    },
                    {
                      "Fn::Join": [
                        "",
                        [
                          {
                            "Ref": "AWS::StackId"
                          },
                          "/*"
                        ]
                      ]
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "ec2:CreateTags",
                    "ec2:DescribeInstances",
                    "ec2:CreateVolume",
                    "ec2:DeleteVolume",
                    "ec2:AttachVolume",
                    "ec2:DetachVolume",
                    "ec2:DescribeVolumes",
                    "ec2:DescribeVolumeStatus",
                    "ec2:DescribeVolumeAttribute",
                    "ec2:CreateSnapshot",
                    "ec2:CopySnapshot",
                    "ec2:DeleteSnapshot",
                    "ec2:DescribeSnapshots",
                    "ec2:DescribeSnapshotAttribute",
                    "ec2:DescribeAvailabilityZones",
                    "ec2:DescribeInstances",
                    "ec2:DescribeTags",
                    "ec2:ModifySnapshotAttribute",
                    "ec2:ModifyVolume",
                    "ec2:ModifyVolumeAttribute",
                    "autoscaling:DescribeAutoScalingGroups",
                    "cloudwatch:PutMetricData",
                    "route53:ChangeResourceRecordSets",
                    "route53:ListResourceRecordSets",
                    "route53:ListHostedZonesByName",
                    "route53:GetChange",
                    "route53:TestDNSAnswer",
                    "ec2:CreateSecurityGroup",
                    "ec2:DeleteSecurityGroup",
                    "ec2:AuthorizeSecurityGroupIngress",
                    "elasticloadbalancing:*",
                    "ec2:DescribeSubnets",
                    "acm:ListCertificates"
                  ],
                  "Resource": "*"
                }
              ]
            },
            "PolicyName": "Slaves"
          },
          {
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "sts:AssumeRole",
                  "Resource": "arn:aws:iam::435375411953:role/dev-qa-marketplace-access"
                }
              ]
            },
            "PolicyName": "marketplace"
          }
        ],
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Action": [
                "sts:AssumeRole"
              ],
              "Principal": {
                "Service": [
                  "ec2.amazonaws.com"
                ]
              },
              "Effect": "Allow"
            }
          ]
        }
      }
    },

    "iaminstanceprofilemaster": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "iamrolemaster"
          }
        ]
      }
    },
    "iaminstanceprofileagent": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "iamroleagent"
          }
        ]
      }
    },

    "internetgateway": {
      "Type": "AWS::EC2::InternetGateway",
      "DependsOn": "vpc",
      "Properties": {
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "vpcgatewayattachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "DependsOn": "internetgateway",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "InternetGatewayId": {
          "Ref": "internetgateway"
        }
      }
    },

    "dhcpoptions": {
      "Type": "AWS::EC2::DHCPOptions",
      "Properties": {
        "DomainNameServers": [
          "AmazonProvidedDNS"
        ],
        "DomainName": {
          "Fn::FindInMap": [
            "DNSMAPPING",
            {
              "Ref": "AWS::Region"
            },
            "NAME"
          ]
        }
      }
    },
    "vpcdhcpoptionsassociation": {
      "Type": "AWS::EC2::VPCDHCPOptionsAssociation",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "DhcpOptionsId": {
          "Ref": "dhcpoptions"
        }
      }
    },

    "networkaclprivate": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "networkaclpublic": {
      "Type": "AWS::EC2::NetworkAcl",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },

    "networkaclentryprivateegress": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "PortRange": {
          "From": "0",
          "To": "65535"
        },
        "RuleNumber": "100",
        "RuleAction": "allow",
        "NetworkAclId": {
          "Ref": "networkaclprivate"
        },
        "Protocol": "-1",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0"
      }
    },
    "networkaclentryprivateingress": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "PortRange": {
          "From": "0",
          "To": "65535"
        },
        "RuleNumber": "100",
        "RuleAction": "allow",
        "NetworkAclId": {
          "Ref": "networkaclprivate"
        },
        "Protocol": "-1",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0"
      }
    },

    "networkaclentrypublicegress": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "PortRange": {
          "From": "0",
          "To": "65535"
        },
        "RuleNumber": "100",
        "RuleAction": "allow",
        "NetworkAclId": {
          "Ref": "networkaclpublic"
        },
        "Protocol": "-1",
        "Egress": "true",
        "CidrBlock": "0.0.0.0/0"
      }
    },
    "networkaclentrypublicingress": {
      "Type": "AWS::EC2::NetworkAclEntry",
      "Properties": {
        "PortRange": {
          "From": "0",
          "To": "65535"
        },
        "RuleNumber": "100",
        "RuleAction": "allow",
        "NetworkAclId": {
          "Ref": "networkaclpublic"
        },
        "Protocol": "-1",
        "Egress": "false",
        "CidrBlock": "0.0.0.0/0"
      }
    },

    "subnetnetworkaclassociationprivatea": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclprivate"
        },
        "SubnetId": {
          "Ref": "subnetprivatea"
        }
      }
    },
    "subnetnetworkaclassociationprivateb": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclprivate"
        },
        "SubnetId": {
          "Ref": "subnetprivateb"
        }
      }
    },
    "subnetnetworkaclassociationprivatec": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclprivate"
        },
        "SubnetId": {
          "Ref": "subnetprivatec"
        }
      }
    },

    "subnetnetworkaclassociationpublica": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclpublic"
        },
        "SubnetId": {
          "Ref": "subnetpublica"
        }
      }
    },
    "subnetnetworkaclassociationpublicb": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclpublic"
        },
        "SubnetId": {
          "Ref": "subnetpublicb"
        }
      }
    },
    "subnetnetworkaclassociationpublicc": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
        "NetworkAclId": {
          "Ref": "networkaclpublic"
        },
        "SubnetId": {
          "Ref": "subnetpublicc"
        }
      }
    },

    "routetableprivatea": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "routetableprivateb": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "routetableprivatec": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },

    "routetablepublica": {
      "Type": "AWS::EC2::RouteTable",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "routetablepublicb": {
      "Type": "AWS::EC2::RouteTable",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },
    "routetablepublicc": {
      "Type": "AWS::EC2::RouteTable",
      "DependsOn": "vpc",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "Application"
          },
          {
            "Value": "Public",
            "Key": "Network"
          }
        ]
      }
    },

    "subnetroutetableassociationprivatea": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivatea"
        },
        "SubnetId": {
          "Ref": "subnetprivatea"
        }
      }
    },
    "subnetroutetableassociationprivateb": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivateb"
        },
        "SubnetId": {
          "Ref": "subnetprivateb"
        }
      }
    },
    "subnetroutetableassociationprivatec": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivatec"
        },
        "SubnetId": {
          "Ref": "subnetprivatec"
        }
      }
    },

    "subnetroutetableassociationpublica": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublica"
        },
        "SubnetId": {
          "Ref": "subnetpublica"
        }
      }
    },
    "subnetroutetableassociationpublicb": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublicb"
        },
        "SubnetId": {
          "Ref": "subnetpublicb"
        }
      }
    },
    "subnetroutetableassociationpublicc": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublicc"
        },
        "SubnetId": {
          "Ref": "subnetpublicc"
        }
      }
    },

    "routeprivatea0": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivatea"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "natgatewaya"
        }
      }
    },
    "routeprivateb0": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivateb"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "natgatewayb"
        }
      }
    },
    "routeprivatec0": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetableprivatec"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "NatGatewayId": {
          "Ref": "natgatewayc"
        }
      }
    },

    "routeprivatea1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetableprivatea"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },
    "routeprivateb1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetableprivateb"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },
    "routeprivatec1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetableprivatec"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },

    "routepublica0": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublica"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "internetgateway"
        }
      }
    },
    "routepublicb0": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublicb"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "internetgateway"
        }
      }
    },
    "routepublicc0": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "routetablepublicc"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "internetgateway"
        }
      }
    },

    "routepublica1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetablepublica"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },
    "routepublicb1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetablepublicb"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },
    "routepublicc1": {
      "Type": "AWS::EC2::Route",
      "Properties": {
        "DestinationCidrBlock": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPC"
          ]
        },
        "RouteTableId": {
          "Ref": "routetablepublicc"
        },
        "VpcPeeringConnectionId": {
          "Fn::FindInMap": [
            "VARIABLES",
            "NETWORK",
            "USEAST1VPCPCID"
          ]
        }
      }
    },

    "rdssubnetgroup0": {
      "Type": "AWS::RDS::DBSubnetGroup",
      "Properties": {
        "DBSubnetGroupDescription": "rdsdbinstance0 subnetgroup",
        "SubnetIds": [
          {
            "Ref": "subnetprivatea"
          },
          {
            "Ref": "subnetprivateb"
          },
          {
            "Ref": "subnetprivatec"
          }
        ]
      }
    },
    "rdsdbinstance0": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "VPCSecurityGroups": [
          {
            "Fn::GetAtt": [
              "securitygroupagentprivate",
              "GroupId"
            ]
          }
        ],
        "AllocatedStorage": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "STORAGE"
          ]
        },
        "AllowMajorVersionUpgrade": "false",
        "AutoMinorVersionUpgrade": "false",
        "BackupRetentionPeriod": 7,
        "DBInstanceClass": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "TYPE"
          ]
        },
        "DBInstanceIdentifier": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "DBNAME"
          ]
        },
        "DBName": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "DBNAME"
          ]
        },
        "DBParameterGroupName": "default.postgres9.6",
        "DBSubnetGroupName": {
          "Ref": "rdssubnetgroup0"
        },
        "Engine": "postgres",
        "EngineVersion": "9.6.1",
        "LicenseModel": "postgresql-license",
        "MasterUsername": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "USER"
          ]
        },
        "MasterUserPassword": {
          "Fn::FindInMap": [
            "VARIABLES",
            "RDS",
            "PASSWORD"
          ]
        },
        "MultiAZ": "true",
        "OptionGroupName": "default:postgres-9-6",
        "Port": "5432",
        "PreferredBackupWindow": "12:00-13:00",
        "PreferredMaintenanceWindow": "sun:10:00-sun:11:00",
        "PubliclyAccessible": "false",
        "StorageEncrypted": "false",
        "StorageType": "standard",
        "Tags": [
          {
            "Key": "Name",
            "Value": "dcos-cloudmgr-db"
          }
        ]
      }
    },

    "launchconfigurationmaster": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": 1,
          "MinInstancesInService": 3,
          "MinSuccessfulInstancesPercent": 100,
          "PauseTime": "PT15M",
          "WaitOnResourceSignals": "true"
        }
      },
      "Properties": {
        "InstanceType": {
          "Fn::FindInMap": [
            "VARIABLES",
            "MASTER",
            "TYPE"
          ]
        },
        "KeyName": {
          "Fn::FindInMap": [
            "VARIABLES",
            "STACK",
            "KEYNAME"
          ]
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupmaster"
          },
          {
            "Ref": "securitygroupagentadminzone"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              ["foo", "bar"]
            ]
          }
        },
        "IamInstanceProfile": {
          "Ref": "iaminstanceprofilemaster"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": true,
              "VolumeSize": {
                "Fn::FindInMap": [
                  "VARIABLES",
                  "MASTER",
                  "ROOTDISK"
                ]
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "AssociatePublicIpAddress": "true",
        "EbsOptimized": "true",
        "ImageId": {
          "Fn::FindInMap": [
            "CENTOS7AMI",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        }
      }
    },
    "launchconfigurationagentprivate": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": 1,
          "MinInstancesInService": 3,
          "MinSuccessfulInstancesPercent": 100,
          "PauseTime": "PT15M",
          "WaitOnResourceSignals": "true"
        }
      },
      "Properties": {
        "InstanceType": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PRIVATEAGENT",
            "TYPE"
          ]
        },
        "KeyName": {
          "Fn::FindInMap": [
            "VARIABLES",
            "STACK",
            "KEYNAME"
          ]
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentprivate"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              ["foo", "bar"]
            ]
          }
        },
        "IamInstanceProfile": {
          "Ref": "iaminstanceprofileagent"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": true,
              "VolumeSize": {
                "Fn::FindInMap": [
                  "VARIABLES",
                  "PRIVATEAGENT",
                  "ROOTDISK"
                ]
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "AssociatePublicIpAddress": "false",
        "EbsOptimized": "true",
        "ImageId": {
          "Fn::FindInMap": [
            "CENTOS7AMI",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        }
      }
    },
    "launchconfigurationagentpublic": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MaxBatchSize": 1,
          "MinInstancesInService": 1,
          "MinSuccessfulInstancesPercent": 100,
          "PauseTime": "PT15M",
          "WaitOnResourceSignals": "true"
        }
      },
      "Properties": {
        "InstanceType": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PUBLICAGENT",
            "TYPE"
          ]
        },
        "KeyName": {
          "Fn::FindInMap": [
            "VARIABLES",
            "STACK",
            "KEYNAME"
          ]
        },
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentpublic"
          }
        ],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": [
              "",
              ["foo", "bar"]
            ]
          }
        },
        "IamInstanceProfile": {
          "Ref": "iaminstanceprofileagent"
        },
        "BlockDeviceMappings": [
          {
            "DeviceName": "/dev/sda1",
            "Ebs": {
              "DeleteOnTermination": true,
              "VolumeSize": {
                "Fn::FindInMap": [
                  "VARIABLES",
                  "PUBLICAGENT",
                  "ROOTDISK"
                ]
              },
              "VolumeType": "gp2"
            }
          }
        ],
        "AssociatePublicIpAddress": "true",
        "EbsOptimized": "true",
        "ImageId": {
          "Fn::FindInMap": [
            "CENTOS7AMI",
            {
              "Ref": "AWS::Region"
            },
            "AMI"
          ]
        }
      }
    },

    "autoscalinggroupmaster": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": {
            "Fn::FindInMap": [
              "VARIABLES",
              "TIMEOUT",
              "STACK"
            ]
          },
          "Count": {
            "Fn::FindInMap": [
              "VARIABLES",
              "MASTER",
              "COUNT"
            ]
          }
        }
      },
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "MinSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "MASTER",
            "COUNT"
          ]
        },
        "LoadBalancerNames": [
          {
            "Ref": "elbmasterexternal"
          },
          {
            "Ref": "elbmasterinternal"
          }
        ],
        "DesiredCapacity": {
          "Fn::FindInMap": [
            "VARIABLES",
            "MASTER",
            "COUNT"
          ]
        },
        "VPCZoneIdentifier": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "launchconfigurationmaster"
        },
        "MaxSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "MASTER",
            "COUNT"
          ]
        },
        "Tags": [
          {
            "PropagateAtLaunch": "true",
            "Key": "Role",
            "Value": "dcos-master"
          }
        ]
      }
    },
    "autoscalinggroupagentprivate": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": {
            "Fn::FindInMap": [
              "VARIABLES",
              "TIMEOUT",
              "STACK"
            ]
          },
          "Count": {
            "Fn::FindInMap": [
              "VARIABLES",
              "PRIVATEAGENT",
              "COUNT"
            ]
          }
        }
      },
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "MinSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PRIVATEAGENT",
            "COUNT"
          ]
        },
        "DesiredCapacity": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PRIVATEAGENT",
            "COUNT"
          ]
        },
        "VPCZoneIdentifier": [
          {
            "Ref": "subnetprivatea"
          },
          {
            "Ref": "subnetprivateb"
          },
          {
            "Ref": "subnetprivatec"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "launchconfigurationagentprivate"
        },
        "MaxSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PRIVATEAGENT",
            "COUNT"
          ]
        },
        "Tags": [
          {
            "PropagateAtLaunch": "true",
            "Key": "Role",
            "Value": "dcos-private-agent"
          }
        ]
      }
    },
    "autoscalinggroupagentpublic": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "CreationPolicy": {
        "ResourceSignal": {
          "Timeout": {
            "Fn::FindInMap": [
              "VARIABLES",
              "TIMEOUT",
              "STACK"
            ]
          },
          "Count": {
            "Fn::FindInMap": [
              "VARIABLES",
              "PUBLICAGENT",
              "COUNT"
            ]
          }
        }
      },
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "MinSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PUBLICAGENT",
            "COUNT"
          ]
        },
        "LoadBalancerNames": [
          {
            "Ref": "elbagentpublicexternal"
          },
          {
            "Ref": "elbagentpublicinternal"
          }
        ],
        "DesiredCapacity": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PUBLICAGENT",
            "COUNT"
          ]
        },
        "VPCZoneIdentifier": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "launchconfigurationagentpublic"
        },
        "MaxSize": {
          "Fn::FindInMap": [
            "VARIABLES",
            "PUBLICAGENT",
            "COUNT"
          ]
        },
        "Tags": [
          {
            "PropagateAtLaunch": "true",
            "Key": "Role",
            "Value": "dcos-public-agent"
          }
        ]
      }
    },

    "securitygroupmaster": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "SecurityGroupIngress": [
          {
            "FromPort": "5050",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "5050"
          },
          {
            "FromPort": "80",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "80"
          },
          {
            "FromPort": "443",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "443"
          },
          {
            "FromPort": "8080",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "8080"
          },
          {
            "FromPort": "8181",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "8181"
          },
          {
            "FromPort": "2181",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "2181"
          },
          {
            "FromPort": "2379",
            "IpProtocol": "tcp",
            "SourceSecurityGroupId": {
              "Ref": "securitygroupelb"
            },
            "ToPort": "2379"
          }
        ],
        "GroupDescription": "Mesos Masters"
      }
    },
    "securitygroupagentprivate": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "GroupDescription": "Mesos Private Agents"
      }
    },
    "securitygroupagentpublic": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "GroupDescription": "Mesos Public Agents"
      }
    },
    "securitygroupagentadminzone": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "SecurityGroupIngress": [
          {
            "FromPort": "22",
            "IpProtocol": "tcp",
            "CidrIp": {
              "Fn::FindInMap": [
                "VARIABLES",
                "STACK",
                "ADMINLOCATION"
              ]
            },
            "ToPort": "22"
          },
          {
            "FromPort": "80",
            "IpProtocol": "tcp",
            "CidrIp": {
              "Fn::FindInMap": [
                "VARIABLES",
                "STACK",
                "ADMINLOCATION"
              ]
            },
            "ToPort": "80"
          },
          {
            "FromPort": "443",
            "IpProtocol": "tcp",
            "CidrIp": {
              "Fn::FindInMap": [
                "VARIABLES",
                "STACK",
                "ADMINLOCATION"
              ]
            },
            "ToPort": "443"
          }
        ],
        "GroupDescription": "Enable Access from Admin Zone"
      }
    },
    "securitygroupelb": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "vpc"
        },
        "GroupDescription": "Mesos Master ELB"
      }
    },

    "ingress00mas2mas": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupmaster"
        },
        "GroupId": {
          "Ref": "securitygroupmaster"
        },
        "ToPort": "65535"
      }
    },
    "ingress01pub2mas": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "GroupId": {
          "Ref": "securitygroupmaster"
        },
        "ToPort": "65535"
      }
    },
    "ingress02pri2mas": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "GroupId": {
          "Ref": "securitygroupmaster"
        },
        "ToPort": "65535"
      }
    },
    "ingress03pri2elb": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "2181",
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "GroupId": {
          "Ref": "securitygroupelb"
        },
        "ToPort": "2181"
      }
    },
    "ingress04pri2elb": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "2379",
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "GroupId": {
          "Ref": "securitygroupelb"
        },
        "ToPort": "2379"
      }
    },
    "ingress04mas2pri": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupmaster"
        },
        "GroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "ToPort": "65535"
      }
    },
    "ingress05pub2pri": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "GroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "ToPort": "65535"
      }
    },
    "ingress06pri2pri": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "GroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "ToPort": "65535"
      }
    },
    "ingress07mas2pub": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupmaster"
        },
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "65535"
      }
    },
    "ingress08pub2pub": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "65535"
      }
    },
    "ingress09pri2pub": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "FromPort": "0",
        "IpProtocol": "-1",
        "SourceSecurityGroupId": {
          "Ref": "securitygroupagentprivate"
        },
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "65535"
      }
    },
    "ingress10pub01": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "0",
        "IpProtocol": "tcp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "21"
      }
    },
    "ingress11pub02": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "23",
        "IpProtocol": "tcp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "5050"
      }
    },
    "ingress12pub03": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "5052",
        "IpProtocol": "tcp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "32000"
      }
    },
    "ingress13pub04": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "0",
        "IpProtocol": "udp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "21"
      }
    },
    "ingress14pub05": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "23",
        "IpProtocol": "udp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "5050"
      }
    },
    "ingress15pub06": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "CidrIp": "0.0.0.0/0",
        "FromPort": "5052",
        "IpProtocol": "udp",
        "GroupId": {
          "Ref": "securitygroupagentpublic"
        },
        "ToPort": "32000"
      }
    },

    "elbmasterexternal": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "Subnets": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "securitygroupelb"
          },
          {
            "Ref": "securitygroupagentadminzone"
          }
        ],
        "Listeners": [
          {
            "LoadBalancerPort": "443",
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "InstancePort": "80",
            "SSLCertificateId": "arn:aws:acm:us-east-1:953558963498:certificate/098ad780-46be-47cc-bb9b-44e1679aced3"
          }
        ],
        "HealthCheck": {
          "HealthyThreshold": "2",
          "Interval": "30",
          "UnhealthyThreshold": "2",
          "Timeout": "5",
          "Target": "TCP:5050"
        }
      }
    },
    "elbmasterinternal": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Subnets": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "securitygroupelb"
          },
          {
            "Ref": "securitygroupagentadminzone"
          },
          {
            "Ref": "securitygroupagentprivate"
          },
          {
            "Ref": "securitygroupagentpublic"
          },
          {
            "Ref": "securitygroupmaster"
          }
        ],
        "Listeners": [
          {
            "LoadBalancerPort": "2379",
            "Protocol": "HTTP",
            "InstanceProtocol": "HTTP",
            "InstancePort": "2379"
          },
          {
            "LoadBalancerPort": "5050",
            "Protocol": "HTTP",
            "InstanceProtocol": "HTTP",
            "InstancePort": "5050"
          },
          {
            "LoadBalancerPort": "2181",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "2181"
          },
          {
            "LoadBalancerPort": "8181",
            "Protocol": "HTTP",
            "InstanceProtocol": "HTTP",
            "InstancePort": "8181"
          },
          {
            "LoadBalancerPort": "80",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "80"
          },
          {
            "LoadBalancerPort": "443",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "443"
          },
          {
            "LoadBalancerPort": "8080",
            "Protocol": "HTTP",
            "InstanceProtocol": "HTTP",
            "InstancePort": "8080"
          }
        ],
        "HealthCheck": {
          "HealthyThreshold": "2",
          "Interval": "30",
          "UnhealthyThreshold": "2",
          "Timeout": "5",
          "Target": "TCP:5050"
        },
        "Scheme": "internal"
      }
    },
    "elbagentpublicinternal": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "Subnets": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "securitygroupelb"
          },
          {
            "Ref": "securitygroupagentadminzone"
          },
          {
            "Ref": "securitygroupagentprivate"
          },
          {
            "Ref": "securitygroupagentpublic"
          },
          {
            "Ref": "securitygroupmaster"
          }
        ],
        "Listeners": [
          {
            "LoadBalancerPort": "80",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "80"
          },
          {
            "LoadBalancerPort": "443",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "443"
          },
          {
            "LoadBalancerPort": "8086",
            "Protocol": "TCP",
            "InstanceProtocol": "TCP",
            "InstancePort": "8086"
          }
        ],
        "HealthCheck": {
          "HealthyThreshold": "2",
          "Interval": "30",
          "UnhealthyThreshold": "2",
          "Timeout": "5",
          "Target": "TCP:80"
        },
        "Scheme": "internal"
      }
    },
    "elbagentpublicexternal": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "DependsOn": "vpcgatewayattachment",
      "Properties": {
        "Subnets": [
          {
            "Ref": "subnetpublica"
          },
          {
            "Ref": "subnetpublicb"
          },
          {
            "Ref": "subnetpublicc"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "securitygroupagentpublic"
          }
        ],
        "Listeners": [
          {
            "LoadBalancerPort": "443",
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "InstancePort": "10080",
            "SSLCertificateId": "arn:aws:acm:us-east-1:953558963498:certificate/098ad780-46be-47cc-bb9b-44e1679aced3"
          },
          {
            "LoadBalancerPort": "4443",
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "InstancePort": "10084",
            "SSLCertificateId": "arn:aws:acm:us-east-1:953558963498:certificate/098ad780-46be-47cc-bb9b-44e1679aced3"
          },
          {
            "LoadBalancerPort": "5443",
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "InstancePort": "10085",
            "SSLCertificateId": "arn:aws:acm:us-east-1:953558963498:certificate/098ad780-46be-47cc-bb9b-44e1679aced3"
          },
          {
            "LoadBalancerPort": "8443",
            "Protocol": "SSL",
            "InstanceProtocol": "TCP",
            "InstancePort": "10090",
            "SSLCertificateId": "arn:aws:acm:us-east-1:953558963498:certificate/098ad780-46be-47cc-bb9b-44e1679aced3"
          }
        ],
        "HealthCheck": {
          "HealthyThreshold": "2",
          "Interval": "5",
          "UnhealthyThreshold": "2",
          "Timeout": "2",
          "Target": "HTTP:9090/_haproxy_health_check"
        }
      }
    }
  }
}
